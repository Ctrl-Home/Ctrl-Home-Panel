{% extends "base.html" %}

{% block title %}
    {% if page_type == 'dashboard' %}
        节点仪表盘
    {% elif node %}
        {% if page_type == 'control' %}
            控制节点 - {{ node.name }}
        {% elif page_type == 'config' %}
            节点配置 - {{ node.name }}
        {% endif %}
    {% endif %}
{% endblock %}

{% block content %}
    <div class="container">
        <h1>
            {% if page_type == 'dashboard' %}
                节点仪表盘
            {% elif node %}
                {% if page_type == 'control' %}
                    控制节点 - {{ node.name }}
                {% elif page_type == 'config' %}
                    节点配置 - {{ node.name }}
                {% endif %}
            {% endif %}
        </h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if page_type == 'dashboard' %}
            <a href="{{ url_for('node.add_node_form') }}" class="btn btn-success mb-3">手动添加节点</a>  {# 添加链接 #}

            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>名称</th>
                        <th>IP 地址</th>
                        <th>端口</th>
                        <th>角色</th>
                        <th>状态</th>
                        <th>最后心跳</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for node in nodes %}
                        <tr>
                            <td>{{ node.id }}</td>
                            <td>{{ node.name }}</td>
                            <td>{{ node.ip_address }}</td>
                            <td>{{ node.port }}</td>
                            <td>{{ node.role }}</td>
                            <td>{{ node.status }}</td>
                            <td>{{ node.last_heartbeat or '从未' }}</td>
                            <td>
                                <a href="{{ url_for('node.update_form', node_id=node.id) }}" class="btn btn-sm btn-warning">更新</a>
                                <a href="{{ url_for('node.control_panel', node_id=node.id) }}" class="btn btn-sm btn-info">控制</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% elif node and page_type == 'control' %}
            {# ... 节点控制面板内容 ... #}
            <h2>控制面板 - {{ node.name }}</h2>
            <!-- 添加控制面板内容，比如发送命令的表单 -->
            <form id="commandForm">
                <div class="mb-3">
                    <label for="command" class="form-label">命令</label>
                    <input type="text" class="form-control" id="command" name="command" required>
                </div>
                <button type="button" class="btn btn-primary" onclick="sendCommand()">发送命令</button>
            </form>

            <script>
            function sendCommand() {
                const command = document.getElementById('command').value;

                const data = {
                    command: command,
                };

                fetch("{{ url_for('node.send_command_route', node_id=node.id) }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    // Handle the response, e.g., show a success message or update the UI
                    return response.json(); // Assuming your server returns JSON
                })
                .then(data => {
                    console.log('Success:', data);
                    // Optionally, display a success message
                    alert("命令已发送!"); // Or use a more sophisticated UI update
                    // You might want to clear the input field:
                    document.getElementById('command').value = '';
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Handle errors, e.g., display an error message
                    alert("发送命令失败: " + error.message); // Or use a more sophisticated error display
                });
            }
            </script>

            <hr>
            <p>节点状态: {{ node.status }}</p>
            {% if 'agent_response' in session %}
                <div class="alert alert-info">
                    <b>Agent 响应:</b> {{ session['agent_response']['message'] }}
                    <pre>{{ session['agent_response'] }}</pre>
                </div>
                {% set _ = session.pop('agent_response') %}  {# 使用 set 和 _ 变量，避免使用 'do' #}
            {% endif %}

        {% elif node and page_type == 'config' %}
            {# ... 节点配置页面内容 ... #}
            <h2>节点配置 - {{ node.name }}</h2>
            <p>IP 地址: {{ node.ip_address }}</p>
            <p>端口: {{ node.port }}</p>
            <p>角色: {{ node.role }}</p>
            <p>协议: {{ node.protocols }}</p>
            <p>状态: {{ node.status }}</p>
            <p>最后心跳: {{ node.last_heartbeat }}</p>
            <!-- 展示配置信息和规则 -->
            {% if config_data and config_data['rules'] %}
                <h3>规则</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>名称</th>
                            <th>来源</th>
                            <th>目标</th>
                            <th>协议</th>
                            <th>节点 ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rule in config_data['rules'] %}
                            <tr>
                                <td>{{ rule.id }}</td>
                                <td>{{ rule.name }}</td>
                                <td>{{ rule.source }}</td>
                                <td>{{ rule.destination }}</td>
                                <td>{{ rule.protocol }}</td>
                                <td>{{ rule.node_id }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>没有找到规则。</p>
            {% endif %}
        {% endif %}
    </div>
{% endblock %}